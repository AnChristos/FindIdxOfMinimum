#include "findMinimumIndex.h"
#include <algorithm>
#include <benchmark/benchmark.h>
#include <random>
/*
 * create global data
 * a bit hacky way
 */
constexpr size_t nstart = 256;
constexpr size_t nn = 16 << 9;
float* inArray;
class InitArray
{
public:
  InitArray()
  {
    constexpr int alignment = 32;
    std::random_device rd;
    std::mt19937 gen(rd());
    std::uniform_real_distribution<> dis(1.0, 10.0);
    // create buffer of right size,properly aligned
    size_t const size = nn * sizeof(float);
    posix_memalign((void**)&inArray, alignment, size);
    for (size_t i = 0; i < nn; ++i) {
      // Use dis to transform the random unsigned int generated by gen into a
      // double. Each call to dis(gen) generates a new random double
      inArray[i] = dis(gen);
    }
  }
  ~InitArray() { free(inArray); }
};
InitArray initArray;

/*
 * C style
 */
static void
findMinimumC(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    int32_t min = findMinC(inArray, n);
    benchmark::DoNotOptimize(&min);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumC)->RangeMultiplier(8)->Range(nstart, nn);

static void
findMinimumIndexC(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    int32_t minIndex = findMinIndexC(inArray, n);
    benchmark::DoNotOptimize(&minIndex);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumIndexC)->RangeMultiplier(8)->Range(nstart, nn);

/*
 * Use STL
 */
static void
findMinimumSTL(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    float minIndex = findMinSTL(inArray, n);
    benchmark::DoNotOptimize(&minIndex);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumSTL)->RangeMultiplier(8)->Range(nstart, nn);

static void
findMinimumIndexSTL(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    int32_t minIndex = findMinIndexSTL(inArray, n);
    benchmark::DoNotOptimize(&minIndex);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumIndexSTL)->RangeMultiplier(8)->Range(nstart, nn);

/*
 * Use vectorized code
 */
static void
findMinimumVec(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    float min = findMinVec(inArray, n);
    benchmark::DoNotOptimize(&min);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumVec)->RangeMultiplier(8)->Range(nstart, nn);

static void
findMinimumIndexVec(benchmark::State& state)
{
  for (auto _ : state) {
    const int n = state.range(0);
    int32_t minIndex = findMinIndexVec(inArray, n);
    benchmark::DoNotOptimize(&minIndex);
    benchmark::ClobberMemory();
  }
}
BENCHMARK(findMinimumIndexVec)->RangeMultiplier(8)->Range(nstart, nn);

BENCHMARK_MAIN();
